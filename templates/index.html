<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Transcription and Summarization</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .page-content {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
        }
        .demo-card-wide.mdl-card {
            width: 45%;
            margin: 10px;
        }
        #transcription, #summary {
            width: 100%;
            height: 200px;
            margin-top: 20px;
        }
        .file-input-container {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .file-input-container .mdl-textfield {
            flex-grow: 1;
            margin-right: 10px;
        }
        .file-input-container .mdl-button--file {
            right: 0;
        }
        .mdl-button--file input {
            cursor: pointer;
            height: 100%;
            right: 0;
            opacity: 0;
            position: absolute;
            top: 0;
            width: 300px;
            z-index: 4;
        }
        .full-width {
            width: 92% !important;
        }
        .mdl-card__title {
            background-color: #3f51b5;
            color: white;
        }
        #summaryRendered {
            width: 100%;
            min-height: 200px;
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
        <header class="mdl-layout__header">
            <div class="mdl-layout__header-row">
                <span class="mdl-layout-title">Audio Transcription and Summarization</span>
            </div>
        </header>
        <main class="mdl-layout__content">
            <div class="page-content">
                <div class="demo-card-wide mdl-card mdl-shadow--2dp">
                    <div class="mdl-card__title">
                        <h2 class="mdl-card__title-text">Upload Audio File</h2>
                    </div>
                    <div class="mdl-card__supporting-text">
                        <form method="POST" enctype="multipart/form-data" id="upload-form">
                            <div class="file-input-container">
                                <div class="mdl-textfield mdl-js-textfield mdl-textfield--file">
                                    <input class="mdl-textfield__input" placeholder="Choose audio file" type="text" id="uploadFile" readonly/>
                                </div>
                                <div class="mdl-button mdl-button--primary mdl-button--icon mdl-button--file">
                                    <i class="material-icons">attach_file</i>
                                    <input type="file" name="audio" accept="audio/*" id="uploadBtn">
                                </div>
                            </div>
                            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                                <input class="mdl-textfield__input" type="text" id="api_key" name="api_key">
                                <label class="mdl-textfield__label" for="api_key">API Key</label>
                            </div>
                            <button class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" type="submit">
                                Transcribe
                            </button>
                        </form>
                    </div>
                    <div class="mdl-card__actions mdl-card--border">
                        <div id="status"></div>
                    </div>
                </div>
                <div class="demo-card-wide mdl-card mdl-shadow--2dp">
                    <div class="mdl-card__title">
                        <h2 class="mdl-card__title-text">Transcript</h2>
                    </div>
                    <div class="mdl-card__supporting-text">
                        <textarea id="transcription" class="mdl-textfield__input" readonly rows="3" placeholder="Transcription will appear here..."></textarea>
                        <button id="summarizeBtn" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent" style="margin-top: 10px;" disabled>
                            Summarize
                        </button>
                    </div>
                </div>
                <div class="demo-card-wide mdl-card mdl-shadow--2dp full-width">
                    <div class="mdl-card__title">
                        <h2 class="mdl-card__title-text">Summary</h2>
                    </div>
                    <div class="mdl-card__supporting-text">
                        <textarea id="summary" class="mdl-textfield__input" readonly rows="3" placeholder="Summary will appear here..."></textarea>
                        <div id="summaryRendered"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const form = document.getElementById('upload-form');
        const statusDiv = document.getElementById('status');
        const transcriptionTextarea = document.getElementById('transcription');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadFile = document.getElementById('uploadFile');
        const summarizeBtn = document.getElementById('summarizeBtn');
        const summaryTextarea = document.getElementById('summary');
        const summaryRendered = document.getElementById('summaryRendered');
        const apiKeyInput = document.getElementById('api_key');

        function saveApiKey(apiKey) {
            localStorage.setItem('openai_api_key', apiKey);
        }

        function loadApiKey() {
            return localStorage.getItem('openai_api_key');
        }

        window.addEventListener('load', () => {
            const savedApiKey = loadApiKey();
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
            }
        });

        uploadBtn.addEventListener('change', function() {
            uploadFile.value = this.files[0].name;
        });

        form.addEventListener('submit', (event) => {
            event.preventDefault();
            statusDiv.textContent = 'Uploading file...';

            saveApiKey(apiKeyInput.value);

            const formData = new FormData(form);
            fetch('/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    statusDiv.textContent = `Error: ${data.error}`;
                } else {
                    statusDiv.textContent = 'Transcription completed';
                    transcriptionTextarea.value = data.transcription;
                    summarizeBtn.disabled = false;
                }
            })
            .catch(error => {
                statusDiv.textContent = `Error: ${error}`;
            });
        });

        summarizeBtn.addEventListener('click', () => {
            const transcription = transcriptionTextarea.value;
            const apiKey = apiKeyInput.value;

            statusDiv.textContent = 'Generating summary...';

            fetch('/summarize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    transcription: transcription,
                    api_key: apiKey
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    statusDiv.textContent = `Error: ${data.error}`;
                } else {
                    statusDiv.textContent = 'Summary completed';
                    summaryTextarea.value = data.summary;
                    summaryRendered.innerHTML = marked.parse(data.summary);
                }
            })
            .catch(error => {
                statusDiv.textContent = `Error: ${error}`;
            });
        });
    </script>
</body>
</html>